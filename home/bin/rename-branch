#!/usr/bin/env bash
set -euo pipefail

usage() {
  echo "Usage: rename-branch <old-name> <new-name> [remote]" >&2
  echo "       rename-branch <new-name> [remote]  (when on the old branch)" >&2
}

if ! git rev-parse --git-dir >/dev/null 2>&1; then
  echo "rename-branch: not inside a git repository" >&2
  exit 2
fi

remote="origin"
old=""
new=""

case "$#" in
  1)
    new="$1"
    ;;
  2)
    if git remote get-url "$2" >/dev/null 2>&1; then
      new="$1"
      remote="$2"
    else
      old="$1"
      new="$2"
    fi
    ;;
  3)
    old="$1"
    new="$2"
    remote="$3"
    ;;
  *)
    usage
    exit 2
    ;;
 esac

if [[ -z "$old" ]]; then
  old="$(git rev-parse --abbrev-ref HEAD)"
fi

if [[ "$old" == "$new" ]]; then
  echo "rename-branch: old and new branch names are the same" >&2
  exit 2
fi

# Rename local branch
if [[ "$old" == "$(git rev-parse --abbrev-ref HEAD)" ]]; then
  git branch -m "$new"
else
  git branch -m "$old" "$new"
fi

# Delete old remote branch and push new branch
if git show-ref --quiet "refs/remotes/$remote/$old"; then
  git push "$remote" ":$old" "$new"
else
  git push "$remote" "$new"
fi

# Set upstream for the new branch
git push "$remote" -u "$new"

